<!doctype html><html lang=en-US data-theme><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>Running crc on M1 machines - CRC - Runs Containers</title><meta name=description content="Since its initial release, CRC has been running on macOS as well as on Windows and Linux. However macOS support was limited to Apple machines with an Intel CPUs until recently. With Apple&rsquo;s ongoing switch to aarch64 M1 CPUs, we&rsquo;ve been asked numerous times when CRC would get M1 support. This has changed with the recently released crc 2.4.1. This blog post will describe the challenges we had to overcome when we decided to add that support."><link rel=icon type=image/x-icon href=https://crc.dev/blog/favicon.ico><link rel=apple-touch-icon-precomposed href=https://crc.dev/blog/favicon.png><link rel=stylesheet href=https://crc.dev/blog/css/style.min.63aba568b2393a8f5a364a508001b05c9412a603d1a0a69bd50f9944649f9c56.css integrity="sha256-Y6ulaLI5Oo9aNkpQgAGwXJQSpgPRoKab1Q+ZRGSfnFY="><script src=https://crc.dev/blog/js/script.min.74bf1a3fcf1af396efa4acf3e660e876b61a2153ab9cbe1893ac24ea6d4f94ee.js type=text/javascript integrity="sha256-dL8aP88a85bvpKzz5mDodrYaIVOrnL4Yk6wk6m1PlO4="></script><meta property="og:title" content="Running crc on M1 machines"><meta property="og:description" content="Since its initial release, CRC has been running on macOS as well as on Windows and Linux. However macOS support was limited to Apple machines with an Intel CPUs until recently. With Apple&rsquo;s ongoing switch to aarch64 M1 CPUs, we&rsquo;ve been asked numerous times when CRC would get M1 support. This has changed with the recently released crc 2.4.1. This blog post will describe the challenges we had to overcome when we decided to add that support."><meta property="og:type" content="article"><meta property="og:url" content="https://crc.dev/blog/posts/2022-06-15-vfkit/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-15T16:08:10+02:00"><meta property="article:modified_time" content="2022-06-15T16:08:10+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Running crc on M1 machines"><meta name=twitter:description content="Since its initial release, CRC has been running on macOS as well as on Windows and Linux. However macOS support was limited to Apple machines with an Intel CPUs until recently. With Apple&rsquo;s ongoing switch to aarch64 M1 CPUs, we&rsquo;ve been asked numerous times when CRC would get M1 support. This has changed with the recently released crc 2.4.1. This blog post will describe the challenges we had to overcome when we decided to add that support."></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><div class=header-top><h1 class=site-title><a href=/blog>CRC - Runs Containers</a></h1><ul class=social-icons><li><a href=https://github.com/crc-org title=Github rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></li><li><a href=mailto:devtools-cdk@redhat.com title=Email rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M464 64H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 4e2V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V4e2H48z"/></svg></span></a></li><li><a href=https://crc.dev/blog/index.xml title=RSS rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></span></a></li></ul></div><nav><a href=https://crc.dev/blog/about/ title=About>About</a>
<a href=https://crc.dev/crc title>Docs</a>
<a href=https://mirror.openshift.com/pub/openshift-v4/clients/crc/ title>Releases</a>
<a href=https://crc.dev/blog/posts/ title=Archive>Archive</a></nav></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">Running crc on M1 machines</h1></header></div><div class="content e-content"><p>Since its initial release, CRC has been running on macOS as well as on Windows and Linux.
However macOS support was limited to Apple machines with an Intel CPUs until recently.
With Apple&rsquo;s ongoing switch to aarch64 M1 CPUs, we&rsquo;ve been asked numerous times when CRC would get M1 support.
This has changed with the recently released <a href=https://github.com/crc-org/crc/releases/tag/v2.4.1>crc 2.4.1</a>.
This blog post will describe the challenges we had to overcome when we decided to add that support.</p><h1 id=background>Background
<span><a href=#background><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>CRC is a tool which allows you to run an OpenShift cluster or podman containers on a laptop or local workstation.
It can be used on a macOS, Windows or Linux machine.
It runs its OpenShift cluster/podman runtime by starting a virtual machine (VM) using a disk image built in advance and packaged in what we call a <em>bundle</em>.
On each platform, we try to use native hypervisors.</p><p>On macOS, crc uses <a href=https://github.com/moby/hyperkit>hyperkit</a> as its
hypervisor. It has served us well over the years, but lately it hasn&rsquo;t seen a
lot of maintainance, and we&rsquo;ve been hitting a few annoying bugs in its <a href=https://github.com/mirage/ocaml-qcow>ocaml
qcow2 implementation</a>.</p><p>However, the main problem with hyperkit is that it&rsquo;s x86_64 only. It does not
provide any M1 support, so we had to look for alternatives if we want to run
CRC on a M1 mac.</p><h1 id=qemu-and-virtualizationframework>QEMU and virtualization.framework
<span><a href=#qemu-and-virtualizationframework><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>When looking for hypervisors we could use on macOS, we found two candidates:</p><ul><li><a href=https://www.qemu.org/>QEMU</a> with its <a href=https://wiki.qemu.org/Features/HVF>hvf acceleration</a></li><li>Apple&rsquo;s own <a href=https://developer.apple.com/documentation/virtualization>virtualization framework</a></li></ul><h2 id=qemu>QEMU
<span><a href=#qemu><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>QEMU is a widely used hypervisor on Linux systems, but it can also be used on
Windows and macOS. On macOS, it can use Apple&rsquo;s <a href=https://developer.apple.com/documentation/hypervisor>hypervisor
framework</a> to make use of
virtualization support in hardware.
It has a huge range of features. In particular it supports many virtio devices including <a href=https://virtio-fs.gitlab.io/>virtiofs</a> for file sharing,
Its main drawback is that for supply chain trust reasons, we&rsquo;d have to maintain
our own QEMU builds, which can be quite an endeavour given the size of QEMU&rsquo;s
code base (2 million lines of C code).</p><h2 id=apples-virtualization-framework>Apple&rsquo;s virtualization framework
<span><a href=#apples-virtualization-framework><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>This is a <a href=https://developer.apple.com/documentation/virtualization>high level Objective-C/swift framework</a> to start virtual machines on Apple hardware with a small set of virtio devices (disk, network, &mldr;).
It was introduced in macOS &lsquo;Big Sur&rsquo; 11.0, and only supports macOS and Linux virtual machines. Luckily, our bundle is a Linux image, so it&rsquo;s good enough for us!
It obviously supports both x86_64 and M1 CPUs.</p><p>Its main advantage and drawback is that it&rsquo;s a high-level framework maintained by Apple. This means very little code is needed to create a virtual machine with it, and Apple maintains and updates all the low-level virtualization code for us.
This is also a drawback, as this framework is closed source. This means we fully depend on Apple for fixing any bugs that we might find. And unfortunately, we&rsquo;ve already hit such bugs in Apple&rsquo;s implementation of virtiofs, a <a href=https://developer.apple.com/bug-reporting/>bug has been filed</a>, but we have no control over when it will get fixed, if ever.</p><h1 id=introducing-vfkit>Introducing vfkit
<span><a href=#introducing-vfkit><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>Apple&rsquo;s virtualization framework looks promising, but it&rsquo;s just a framework. A framework is similar to a shared library on Linux, your code can link to it to use what it offers, but you can&rsquo;t directly use it as a commandline or GUI tool.
One particular caveat with the virtualization framework is that any virtual machines you start with it will only stay alive as long as the process which started it is alive.</p><p>We could not find any pre-existing FOSS commandline tool to manage virtual machines with Apple&rsquo;s virtualization framework, but luckily for us, there are <a href=https://github.com/Code-Hex/vz>go bindings for it</a>.
This allowed us to write a small commandline wrapper using these bindings which we called <a href=https://github.com/crc-org/vfkit><code>vfkit</code></a>
It does not cover all features exposed by <code>Code-Hex/vz</code> and the virtualization framework, but we can expand this over time. At the moment, its commandline is enough for CRC&rsquo;s needs, including support for both system and usermode networking.</p><h1 id=where-were-at>Where we&rsquo;re at
<span><a href=#where-were-at><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>With <code>vfkit</code>, we have a way of starting virtual machines on M1 hardware. The second thing that we need is a bundle with the appropriate disk images. The two main changes we had to do were:</p><ul><li>move from qcow2 to raw disk images as this is the only format Apple&rsquo;s virtualization framework supports. This meant modifying CRC to make use of <a href=https://en.wikipedia.org/wiki/Sparse_file>sparse files</a> as much as possible to minimize disk usage. The <a href=https://www.manpagez.com/man/2/clonefile/><code>clonefile</code></a> system call was also very handy to limit the amount of disk space that we use</li><li>the <a href=https://www.kernel.org/doc/Documentation/arm64/booting.txt>aarch64 kernel <strong>must</strong> be uncompressed</a>, otherwise the virtual machine won&rsquo;t start. This is fairly tedious to figure out as you don&rsquo;t get any output from the virtual machine to let you know what went wrong.</li></ul><p>After these changes, we were able to generate a podman bundle to use natively on a M1 machine. As its x86_64 counterpart, this bundle is built on top of Fedora CoreOS.
Running OpenShift on a M1 CPU won&rsquo;t be possible soon, as it&rsquo;s currently based on Red Hat CoreOS 8, and <a href=https://access.redhat.com/solutions/6545411>its kernel is incompatible with M1 CPUs</a>.</p><p><code>vfkit</code> support for x86_64 hardware landed in crc 2.3.0 release, and so far did not have many issues reported.
We merged M1 vfkit support in crc 2.4.1, but had last minute issues related to signing, so it&rsquo;s only available as an <a href=https://github.com/crc-org/crc/releases/download/v2.4.1/crc-macos-unsigned-arm64.pkg>unsigned installer</a> for this release. Hopefully this will be solved in time for crc 2.5.</p><p>Once this is finalized, we still have plenty to explore in vfkit and M1 support: file sharing support, OKD bundles, microshift bundles, &mldr; so stay tuned!</p><p>As usual, we&rsquo;d like to get as much <a href=https://github.com/crc-org/crc/issues/new/choose>feedback</a> as possible on all this work!</p></div><div class=post-info><div class="post-date dt-published">2022-06-15</div><a class="post-hidden-url u-url" href=https://crc.dev/blog/posts/2022-06-15-vfkit/>https://crc.dev/blog/posts/2022-06-15-vfkit/</a>
<a href=https://crc.dev/blog/ class="p-name p-author post-hidden-author h-card" rel=me>CRC Contributors</a><div class=post-taxonomies></div></div></article><div class="pagination post-pagination"><div class="left pagination-item"><a href=/blog/posts/2022-08-17-ocp-on-m1/>Running ocp on M1 machines</a></div><div class="right pagination-item disabled"></div></div></main><footer class=common-footer><div class=common-footer-bottom><div class=copyright><p>Â© CRC Contributors, 2023<br>Powered by <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, theme <a target=_blank rel="noopener noreferrer" href=https://github.com/mitrichius/hugo-theme-anubis>Anubis</a>.<br></p></div><button class=theme-switcher>
Dark theme</button>
<script>const STORAGE_KEY="user-color-scheme",defaultTheme="light";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeButtonText()};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme=="dark"&&document.documentElement.setAttribute("data-theme","dark"),currentTheme=="auto"&&(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)),changeButtonText(),switchButton.addEventListener("click",switchTheme,!1)});function detectCurrentScheme(){return localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":"light"}function changeButtonText(){switchButton.textContent=currentTheme=="dark"?"Light theme":"Dark theme"}function switchTheme(){currentTheme=="dark"?(localStorage.setItem(STORAGE_KEY,"light"),document.documentElement.setAttribute("data-theme","light"),currentTheme="light"):(localStorage.setItem(STORAGE_KEY,"dark"),document.documentElement.setAttribute("data-theme","dark"),currentTheme="dark"),changeButtonText()}</script></div><p class="h-card vcard"><a href=https://crc.dev/blog/ class="p-name u-url url fn" rel=me>CRC Contributors</a></p></footer></div></body></html>